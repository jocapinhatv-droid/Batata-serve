<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>Jogo 2D Completo - Paisagem Mobile</title>
<style>
  html, body {
    margin: 0; padding: 0; height: 100%; width: 100%;
    background: #222; color: #eee;
    font-family: Arial, sans-serif;
    overflow: hidden;
    display: flex; justify-content: center; align-items: center;
  }
  #wrapper {
    position: relative;
    width: 600px;
    height: 400px;
    background: #333;
    border-radius: 15px;
    overflow: hidden;
    box-shadow: 0 0 15px #000;
    user-select: none;
    /* Tela virada pro celular - paisagem */
    transform-origin: center center;
    transform: rotate(90deg);
  }
  .screen {
    display: none;
    flex-direction: column;
    height: 100%;
    width: 100%;
    box-sizing: border-box;
    padding: 15px;
  }
  .screen.active {
    display: flex;
  }
  input, button {
    font-size: 16px;
    padding: 8px;
    margin: 5px 0;
    border-radius: 5px;
    border: none;
    outline: none;
  }
  button {
    background: #555;
    color: white;
    cursor: pointer;
  }
  button:hover {
    background: #666;
  }
  #login-message, #code-message {
    margin-top: 5px; min-height: 20px; font-weight: bold;
  }
  #buttons-row {
    display: flex; justify-content: space-between; margin-top: 10px;
    flex-wrap: wrap;
  }
  #code-area {
    width: 180px; display: flex; flex-direction: column;
  }
  #inventory {
    background: #444; padding: 10px; border-radius: 6px; flex-grow: 1; color: #eee; min-width: 180px;
    max-height: 150px;
    overflow-y: auto;
  }
  #inventory button {
    margin: 5px 3px 5px 0;
    min-width: 80px;
    background: #666;
    color: white;
    border-radius: 6px;
    border: none;
    cursor: pointer;
  }
  #inventory button.selected {
    background-color: #4a4;
  }
  #player-info {
    color: #eee; font-weight: bold; user-select: none;
    text-align: right;
    margin-bottom: 5px;
  }
  #game-screen {
    position: relative;
    background: #111;
    border-radius: 15px;
    width: 100%;
    height: 100%;
  }
  #weapon-left {
    position: absolute; left: 10px; top: 50%; transform: translateY(-50%);
    width: 80px; height: 80px; background: #222; border-radius: 10px;
    display: flex; justify-content: center; align-items: center;
  }
  #weapon-left img {
    max-width: 60px; max-height: 60px;
    pointer-events: none;
  }
  #score-display {
    position: absolute; top: 10px; right: 10px; color: #fff;
    font-size: 20px; font-weight: bold;
    user-select: none;
  }
  #btn-voltar {
    position: absolute; top: 10px; left: 10px;
    background: #555; padding: 8px 12px; border-radius: 6px;
    border: none; color: white; cursor: pointer;
    z-index: 10;
  }
  #btn-voltar:hover {
    background: #666;
  }
  #game-canvas {
    border-radius: 10px;
    background: #222;
    cursor: crosshair;
    display: block;
    margin-left: 100px;
    height: 100%;
    width: calc(100% - 100px);
  }
</style>
</head>
<body>
  <div id="wrapper">

    <!-- LOGIN -->
    <div id="login-screen" class="screen active">
      <h2>Login / Criar Conta</h2>
      <input id="username" type="text" placeholder="Nome de usuário" autocomplete="off" />
      <input id="password" type="password" placeholder="Senha" autocomplete="off" />
      <button id="btn-login">Logar</button>
      <button id="btn-create">Criar Conta</button>
      <p id="login-message"></p>
    </div>

    <!-- LOBBY -->
    <div id="lobby-screen" class="screen">
      <h2>Lobby</h2>
      <button id="btn-play">Jogar</button>
      <div id="player-info">
        Jogador: <span id="player-name"></span><br />
        Pontos: <span id="player-points">0</span>
      </div>
      <div id="buttons-row">
        <div id="code-area">
          <input id="code-input" type="text" placeholder="Insira código" autocomplete="off" />
          <button id="btn-send-code">Enviar Código</button>
          <p id="code-message"></p>
        </div>
        <div id="inventory">
          <strong>Inventário:</strong><br />
          <div id="weapon-list"></div>
        </div>
      </div>
    </div>

    <!-- JOGO -->
    <div id="game-screen" class="screen">
      <button id="btn-voltar">Voltar ao Menu</button>
      <div id="weapon-left">Nenhuma arma</div>
      <div id="score-display">Pontos: 0</div>
      <canvas id="game-canvas" width="600" height="400"></canvas>
    </div>

  </div>

<script>
document.addEventListener('DOMContentLoaded', () => {
  const STORAGE_KEY = 'jogo2d_contas';
  let contas = JSON.parse(localStorage.getItem(STORAGE_KEY)) || {};
  let userAtivo = null;

  // DOM
  const loginScreen = document.getElementById('login-screen');
  const lobbyScreen = document.getElementById('lobby-screen');
  const gameScreen = document.getElementById('game-screen');
  const loginMessage = document.getElementById('login-message');
  const codeMessage = document.getElementById('code-message');
  const weaponLeft = document.getElementById('weapon-left');
  const weaponListDiv = document.getElementById('weapon-list');
  const scoreDisplay = document.getElementById('score-display');
  const playerNameSpan = document.getElementById('player-name');
  const playerPointsSpan = document.getElementById('player-points');
  const btnVoltar = document.getElementById('btn-voltar');
  const btnLogin = document.getElementById('btn-login');
  const btnCreate = document.getElementById('btn-create');
  const btnPlay = document.getElementById('btn-play');
  const btnSendCode = document.getElementById('btn-send-code');
  const inputUsername = document.getElementById('username');
  const inputPassword = document.getElementById('password');
  const inputCode = document.getElementById('code-input');
  const canvas = document.getElementById('game-canvas');
  const ctx = canvas.getContext('2d');

  // Info das armas
  const armasInfo = {
    'Normal': { damage: 1, fireRate: 400, imgSrc: 'https://i.imgur.com/ojS8Ksv.png', scale: 0.05, tirosParaQuebrar: 4, img: null },
    'Pistola': { damage: 2, fireRate: 300, imgSrc: 'https://i.imgur.com/ciL6yLc.png', scale: 0.03, tirosParaQuebrar: 2, img: null }
  };

  // Carregar imagens das armas
  function carregarImagens() {
    for (let nome in armasInfo) {
      let img = new Image();
      img.src = armasInfo[nome].imgSrc;
      armasInfo[nome].img = img;
    }
  }
  carregarImagens();

  function salvarContas() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify(contas));
  }

  function criarConta(user, pass) {
    if (contas[user]) return false;
    contas[user] = {
      password: pass,
      inventory: ['Normal'],
      equipped: 'Normal',
      points: 0
    };
    salvarContas();
    return true;
  }

  function logar(user, pass) {
    if (contas[user] && contas[user].password === pass) {
      userAtivo = user;
      return true;
    }
    return false;
  }

  function atualizarInventario() {
    const inv = contas[userAtivo].inventory;
    const equipado = contas[userAtivo].equipped || 'Normal';
    weaponListDiv.innerHTML = '';
    if (inv.length === 0) {
      weaponListDiv.innerHTML = '<em>Nenhuma arma</em>';
      return;
    }
    inv.forEach(arma => {
      const btn = document.createElement('button');
      btn.textContent = arma;
      if (arma === equipado) btn.classList.add('selected');
      btn.onclick = () => {
        contas[userAtivo].equipped = arma;
        salvarContas();
        atualizarInventario();
        mostrarArmaEsquerda();
      };
      weaponListDiv.appendChild(btn);
    });
  }

  function atualizarPlayerInfo() {
    playerNameSpan.textContent = userAtivo;
    playerPointsSpan.textContent = contas[userAtivo].points;
  }

  function mostrarTela(tela) {
    [loginScreen, lobbyScreen, gameScreen].forEach(s => s.classList.remove('active'));
    tela.classList.add('active');
  }

  // Variáveis do jogo
  let caixas = [];
  let tiros = [];
  let pontos = 0;
  let animId = null;
  let caixaTimer = null;

  const arma = {
    name: null,
    x: 60,
    y: canvas.height / 2,
    angle: 0,
    lastFire: 0
  };

  function mostrarArmaEsquerda() {
    weaponLeft.innerHTML = '';
    const img = armasInfo[arma.name].img;
    if (img && img.complete) {
      const i = document.createElement('img');
      i.src = img.src;
      i.style.maxWidth = '60px';
      i.style.maxHeight = '60px';
      weaponLeft.appendChild(i);
    } else {
      weaponLeft.textContent = arma.name;
    }
  }

  function atualizarPontos() {
    scoreDisplay.textContent = 'Pontos: ' + pontos;
    playerPointsSpan.textContent = pontos;
    contas[userAtivo].points = pontos;
    salvarContas();
  }

  function iniciarJogo() {
    caixas = [];
    tiros = [];
    pontos = contas[userAtivo].points || 0;
    atualizarPontos();

    arma.name = contas[userAtivo].equipped || 'Normal';
    arma.angle = 0;
    arma.lastFire = 0;

    mostrarArmaEsquerda();

    if (caixaTimer) clearInterval(caixaTimer);
    caixaTimer = setInterval(() => {
      caixas.push({
        x: canvas.width - 40,
        y: 0,
        width: 40,
        height: 40,
        speedY: 3,
        slowed: false,
        vida: armasInfo['Normal'].tirosParaQuebrar
      });
    }, 2000);

    if (animId) cancelAnimationFrame(animId);
    animId = requestAnimationFrame(loopJogo);
  }

  function pararJogo() {
    if (animId) cancelAnimationFrame(animId);
    if (caixaTimer) clearInterval(caixaTimer);
  }

  canvas.addEventListener('click', e => {
    if (!arma.name) return;
    const rect = canvas.getBoundingClientRect();
    const clickX = e.clientX - rect.left;
    const clickY = e.clientY - rect.top;

    const dx = clickX - arma.x;
    const dy = clickY - arma.y;
    arma.angle = Math.atan2(dy, dx);

    const now = Date.now();
    if (now - arma.lastFire >= armasInfo[arma.name].fireRate) {
      arma.lastFire = now;
      tiros.push({
        x: arma.x,
        y: arma.y,
        angle: arma.angle,
        speed: 10,
        width: 8,
        height: 4,
        damage: armasInfo[arma.name].damage
      });
    }
  });

  function loopJogo() {
    ctx.clearRect(0, 0, canvas.width, canvas.height);

    // Atualiza caixas
    for (let i = caixas.length - 1; i >= 0; i--) {
      const box = caixas[i];
      if (!box.slowed && box.y >= canvas.height / 2) {
        box.speedY = 1;
        box.slowed = true;
      }
      box.y += box.speedY;

      // Vida da caixa representada pela cor (vermelho pra quebrado)
      let vidaMax = armasInfo['Normal'].tirosParaQuebrar;
      let vidaRatio = box.vida / vidaMax;
      if (vidaRatio < 0) vidaRatio = 0;
      const r = Math.floor(187 * vidaRatio + 68 * (1 - vidaRatio));
      const g = Math.floor(68 * vidaRatio + 68 * (1 - vidaRatio));
      const b = Math.floor(68 * vidaRatio + 68 * (1 - vidaRatio));
      ctx.fillStyle = `rgb(${r},${g},${b})`;
      ctx.fillRect(box.x, box.y, box.width, box.height);

      if (box.vida <= 0) {
        caixas.splice(i, 1);
        pontos++;
        atualizarPontos();
        atualizarPlayerInfo();
        continue;
      }

      if (box.y > canvas.height) {
        caixas.splice(i, 1);
      }
    }

    // Atualiza tiros
    for (let i = tiros.length - 1; i >= 0; i--) {
      const tiro = tiros[i];
      tiro.x += Math.cos(tiro.angle) * tiro.speed;
      tiro.y += Math.sin(tiro.angle) * tiro.speed;

      ctx.save();
      ctx.translate(tiro.x, tiro.y);
      ctx.rotate(tiro.angle);
      ctx.fillStyle = 'yellow';
      ctx.fillRect(0, -tiro.height / 2, tiro.width, tiro.height);
      ctx.restore();

      let colidiu = false;
      for (let j = caixas.length - 1; j >= 0; j--) {
        const box = caixas[j];
        if (
          tiro.x > box.x &&
          tiro.x < box.x + box.width &&
          tiro.y > box.y &&
          tiro.y < box.y + box.height
        ) {
          box.vida -= tiro.damage;
          tiros.splice(i, 1);
          colidiu = true;
          break;
        }
      }
      if (colidiu) continue;

      if (tiro.x < 0 || tiro.x > canvas.width || tiro.y < 0 || tiro.y > canvas.height) {
        tiros.splice(i, 1);
      }
    }

    // Desenha arma na posição e ângulo
    const imgArma = armasInfo[arma.name].img;
    if (imgArma && imgArma.complete) {
      ctx.save();
      ctx.translate(arma.x, arma.y);
      ctx.rotate(arma.angle);
      const scale = armasInfo[arma.name].scale;
      const w = imgArma.width * scale;
      const h = imgArma.height * scale;
      ctx.drawImage(imgArma, -w / 2, -h / 2, w, h);
      ctx.restore();
    }

    animId = requestAnimationFrame(loopJogo);
  }

  // Eventos dos botões
  btnCreate.onclick = () => {
    loginMessage.textContent = '';
    loginMessage.style.color = '#f44';
    const user = inputUsername.value.trim();
    const pass = inputPassword.value;
    if (!user || !pass) {
      loginMessage.textContent = 'Preencha nome e senha.';
      return;
    }
    if (criarConta(user, pass)) {
      loginMessage.style.color = '#4f4';
      loginMessage.textContent = 'Conta criada! Faça login.';
    } else {
      loginMessage.textContent = 'Nome indisponível.';
    }
  };

  btnLogin.onclick = () => {
    loginMessage.textContent = '';
    loginMessage.style.color = '#f44';
    const user = inputUsername.value.trim();
    const pass = inputPassword.value;
    if (!user || !pass) {
      loginMessage.textContent = 'Preencha nome e senha.';
      return;
    }
    if (logar(user, pass)) {
      loginMessage.style.color = '#4f4';
      loginMessage.textContent = 'Logado com sucesso!';
      inputUsername.value = '';
      inputPassword.value = '';
      atualizarInventario();
      atualizarPlayerInfo();
      mostrarTela(lobbyScreen);
    } else {
      loginMessage.textContent = 'Usuário ou senha incorretos.';
    }
  };

  btnSendCode.onclick = () => {
    codeMessage
